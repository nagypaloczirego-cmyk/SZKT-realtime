<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<title>Trolibusz figyel≈ë</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="/static/styles.css">
</head>

<body>

<header>
  <h1>üöé Trolibusz figyel≈ë</h1>
  <button id="refreshBtn">Friss√≠t√©s</button>
</header>

<nav>
  <button class="tab active" data-tab="skoda">Akt√≠v ≈†koda</button>
  <button class="tab" data-tab="all">√ñsszes troli</button>
</nav>

<main>

<div id="loadingText" class="loading">Bet√∂lt√©s‚Ä¶</div>

<section id="panel-skoda" class="panel hidden">
<h2>Akt√≠v ≈†koda trolibuszok</h2>
<table>
<thead>
<tr>
  <th>Rendsz√°m</th>
  <th>Vonal</th>
  <th>C√©l</th>
  <th>Meg√°ll√≥</th>
  <th>Indul√°s (mp)</th>
</tr>
</thead>
<tbody id="skodaBody"></tbody>
</table>
</section>

<section id="panel-all" class="panel hidden">
<h2>√ñsszes akt√≠v troli</h2>
<table>
<thead>
<tr>
  <th>Rendsz√°m</th>
  <th>Vonal</th>
  <th>C√©l</th>
  <th>Meg√°ll√≥</th>
  <th>Indul√°s (mp)</th>
</tr>
</thead>
<tbody id="allBody"></tbody>
</table>
</section>

</main>

<script>
const API_BASE = window.location.origin;

const loadingText = document.getElementById("loadingText");
const panelSkoda = document.getElementById("panel-skoda");
const panelAll   = document.getElementById("panel-all");

document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    panelSkoda.classList.toggle("hidden", t.dataset.tab!=="skoda");
    panelAll.classList.toggle("hidden", t.dataset.tab!=="all");
  };
});

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function render(body,data){
  body.innerHTML="";
  for(const i of data){
    body.insertAdjacentHTML("beforeend",`
      <tr>
        <td class="mono">${esc(i.reg)}</td>
        <td>${esc(i.line)}</td>
        <td>${esc(i.dest)}</td>
        <td class="mono">${esc(i.stop)}</td>
        <td class="mono">${esc(i.dep)}</td>
      </tr>
    `);
  }
}

async function fetchJSON(url){
  try{
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) return [];
    return await r.json();
  }catch{
    return [];
  }
}

async function refresh(){
  loadingText.classList.remove("hidden");
  panelSkoda.classList.add("hidden");
  panelAll.classList.add("hidden");

  const skoda = await fetchJSON(API_BASE+"/api/allskoda");
  const all   = await fetchJSON(API_BASE+"/api/alltroli");

  render(document.getElementById("skodaBody"), skoda);
  render(document.getElementById("allBody"), all);

  loadingText.classList.add("hidden");
  panelSkoda.classList.remove("hidden");
}

document.getElementById("refreshBtn").onclick = refresh;
refresh();
</script>

</body>
</html>

<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<title><title>SZKT Trolleybus Realtime ‚Äì Szegedi troli val√≥s idej≈± adatok</title>
</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="/static/styles.css">

<style>
/* ===== MOBIL JAV√çT√ÅS ===== */
@media (max-width: 768px){

  header{
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }

  nav{
    flex-wrap: wrap;
    gap: 8px;
  }

  .panel{
    width: 100%;
    overflow-x: auto;
  }

  table{
    min-width: 600px;
  }

  th, td{
    font-size: 13px;
    padding: 8px;
    white-space: nowrap;
  }

  h2{
    font-size: 16px;
  }

  button{
    font-size: 14px;
  }
}
</style>
</head>

<body>

<header>
  <h1>üöé Trolibusz figyel≈ë</h1>
  <div>
    <button id="refreshBtn">Friss√≠t√©s</button>
    <button id="autoBtn">üîÑ Auto: KI</button>
  </div>
</header>

<nav>
  <button class="tab active" data-tab="skoda">Akt√≠v ≈†koda</button>
  <button class="tab" data-tab="all">√ñsszes troli</button>
</nav>

<main>

<div id="loadingText" class="loading">Bet√∂lt√©s‚Ä¶</div>

<section id="panel-skoda" class="panel hidden">
<h2>Akt√≠v ≈†koda trolibuszok</h2>
<table>
<thead>
<tr>
  <th>Rendsz√°m</th>
  <th>Vonal</th>
  <th>C√©l</th>
  <th>Meg√°ll√≥</th>
  <th>Indul√°s</th>
</tr>
</thead>
<tbody id="skodaBody"></tbody>
</table>
</section>

<section id="panel-all" class="panel hidden">
<h2>√ñsszes akt√≠v troli</h2>
<table>
<thead>
<tr>
  <th>Rendsz√°m</th>
  <th>Vonal</th>
  <th>C√©l</th>
  <th>Meg√°ll√≥</th>
  <th>Indul√°s</th>
</tr>
</thead>
<tbody id="allBody"></tbody>
</table>
</section>

</main>

<script>
const API_BASE = window.location.origin;

const loadingText = document.getElementById("loadingText");
const panelSkoda = document.getElementById("panel-skoda");
const panelAll   = document.getElementById("panel-all");

document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    panelSkoda.classList.toggle("hidden", t.dataset.tab!=="skoda");
    panelAll.classList.toggle("hidden", t.dataset.tab!=="all");
  };
});

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function formatDep(sec){
  if(sec == null) return "";
  if(sec < 0) return "most";
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return m ? `${m}p ${s}mp` : `${s}mp`;
}

function render(body,data){
  body.innerHTML="";
  for(const i of data){
    body.insertAdjacentHTML("beforeend",`
      <tr>
        <td class="mono">${esc(i.reg)}</td>
        <td>${esc(i.line)}</td>
        <td>${esc(i.dest)}</td>
        <td class="mono">${esc(i.stop)}</td>
        <td class="mono">${formatDep(i.dep)}</td>
      </tr>
    `);
  }
}

async function fetchJSON(url){
  try{
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) return [];
    return await r.json();
  }catch{
    return [];
  }
}

async function refresh(){
  loadingText.classList.remove("hidden");
  panelSkoda.classList.add("hidden");
  panelAll.classList.add("hidden");

  const skoda = await fetchJSON(API_BASE+"/api/allskoda");
  const all   = await fetchJSON(API_BASE+"/api/alltroli");

  render(document.getElementById("skodaBody"), skoda);
  render(document.getElementById("allBody"), all);

  loadingText.classList.add("hidden");

  if(document.querySelector(".tab.active").dataset.tab === "skoda"){
    panelSkoda.classList.remove("hidden");
  }else{
    panelAll.classList.remove("hidden");
  }
}

document.getElementById("refreshBtn").onclick = refresh;

/* ===== AUTO FRISS√çT√âS ===== */
let autoTimer = null;
let autoOn = false;

function toggleAuto(){
  autoOn = !autoOn;
  const btn = document.getElementById("autoBtn");

  if(autoOn){
    btn.textContent = "üîÑ Auto: BE";
    refresh();
    autoTimer = setInterval(refresh, 30000);
  }else{
    btn.textContent = "üîÑ Auto: KI";
    clearInterval(autoTimer);
  }
}

document.getElementById("autoBtn").onclick = toggleAuto;

refresh();
</script>

</body>
</html>
